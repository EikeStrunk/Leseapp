<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Borg Protokoll</title>
    <style>
        /* --- 1. DER HINTERGRUND-LAYER --- */
        /* Wir l√∂sen den Hintergrund komplett vom Body, das ist am sichersten */
        #fixed-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -9999; /* Ganz weit nach hinten */
            
            /* DEBUG-FARBE: Wenn du ROT siehst, wird das Bild nicht gefunden! */
            background-color: #550000; 
            
            /* Das Bild */
            background-image: url('borg.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover; /* F√ºllt den Screen */
        }

        /* --- 2. BASIS-LAYOUT --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            background-color: transparent; /* WICHTIG: Durchsichtig! */
            color: #C0C0C0;
        }

        /* --- 3. VIDEO SCREEN (Leicht durchsichtig) --- */
        #videoIntroScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            
            /* Transparenz erh√∂ht: 0.8 statt 0.9, damit man den BG besser sieht */
            background-color: rgba(0, 0, 0, 0.8); 
            
            z-index: 100;
            text-align: center;
            transition: opacity 0.5s ease-out;
        }

        #videoIntroScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #videoElement {
            width: 80%;
            max-width: 600px;
            border: 2px solid #00FF00; 
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
            margin-bottom: 20px;
            border-radius: 8px;
        }

        #videoIntroScreen h2 {
            color: #00FF00; 
            font-size: 1.5rem; 
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
        }

        .intro-buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .intro-button {
            padding: 15px;
            font-size: 1.1rem;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            background-color: #00FF00; 
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
        }

        /* --- 4. HAUPTBEREICH (Wortanzeige) --- */
        #wordDisplayArea {
            display: none; 
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 10; 
        }

        .screen-container {
            position: relative;
            width: 90%;
            height: 50vh; 
            margin-top: 10vh; /* Etwas tiefer */
            display: flex;
            justify-content: center; 
            align-items: center;
            flex-direction: column;
        }

        #wordDisplay {
            width: 100%;
            display: flex;
            justify-content: center; 
            align-items: center;     
            color: #00FF00; 
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8), 0 0 5px black;
            text-align: center;
        }

        #wordDisplay span {
            display: none; 
            width: 100%;
            word-wrap: break-word; 
        }

        #initialMessage {
            position: absolute;
            bottom: -20%; 
            width: 100%;
            font-size: 1.5rem; 
            text-align: center;
            color: #00FF00;
        }
        
        .feedback-correct { color: #00FF00 !important; }
        .feedback-incorrect { color: red !important; }

        /* --- 5. BUTTONS UNTEN --- */
        .control-buttons {
            position: absolute; 
            bottom: 50px; 
            width: 90%;
            left: 5%;
            display: flex;
            flex-direction: column; 
            gap: 15px;
            z-index: 50; 
        }
        
        .control-buttons button {
            padding: 15px;
            font-size: 1.1rem;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.7); 
            width: 100%; 
        }
        
        #startButton, #nextWordButton { background-color: #00FF00; }
        #readButton { background-color: #00FF00; }
        #readButton.recording { background-color: red; box-shadow: 0 0 15px red; color: white;}

        button:disabled {
            background-color: #444 !important;
            color: #888 !important;
            box-shadow: none !important;
        }

    </style>
</head>
<body>

    <div id="fixed-background"></div>

    <div id="videoIntroScreen">
        <h2>Zielsystem Scan</h2>
        <video id="videoElement" src="your_video.mp4" controls playsinline preload="auto"></video>
        <div class="intro-buttons-container">
            <button class="intro-button" id="playVideoButton">‚ñ∂ Video</button>
            <button class="intro-button" id="skipToReadButton">‚è© Lesen</button>
        </div>
    </div>

    <div id="wordDisplayArea">
        <div class="screen-container">
            <div id="wordDisplay"></div>
            <p id="initialMessage">Initialisiere...</p>
        </div>
        
        <div class="control-buttons" id="fixedControlButtons">
            <button id="startButton" disabled>Ich bin bereit</button>
            <button id="readButton" disabled>üé§ Laut vorlesen</button>
            <button id="nextWordButton" disabled>N√§chstes Wort (0/10)</button> 
        </div>
    </div>

    <script>
        const videoIntroScreen = document.getElementById('videoIntroScreen');
        const videoElement = document.getElementById('videoElement');
        const playVideoButton = document.getElementById('playVideoButton');
        const skipToReadButton = document.getElementById('skipToReadButton');
        const wordDisplayArea = document.getElementById('wordDisplayArea');
        const wordDisplay = document.getElementById('wordDisplay');
        const initialMessage = document.getElementById('initialMessage');
        const startButton = document.getElementById('startButton');
        const nextWordButton = document.getElementById('nextWordButton');
        const readButton = document.getElementById('readButton');
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        const WORD_POOL_WORDS = ["Kosmos", "Saturn", "Orbit", "Galaxie", "Nebel", "Astral", "Plasma", "Gravit", "Titan", "Komet", "Mond", "Sonne", "Venus", "Mars", "Alpha", "Stern", "Vakuum", "Raum", "Start", "Pilot", "Laser", "Hyper", "Terra", "Nova", "Licht", "Staub", "Schiff", "Ferne", "Spion", "Quasar", "Ringe", "Astro", "Blitz", "Himmel", "Aura", "Erde", "G√ºrtel", "Chaos", "Glimmer", "Tr√§ger", "Sonden", "Dunkel", "Weiten", "Faktor", "Reaktor", "Jupyter", "Signal", "Welle", "Meter"];
        const WORD_POOL_SENTENCES = ["Die Galaxie dreht sich schnell.", "Der Komet kommt n√§her.", "Warte auf das Signal.", "Das Schiff driftet ab.", "Tausend Sterne warten.", "Wir sind nicht allein.", "Der Flug ist vorbei.", "Aktiviere den Hyperraum.", "Das Vakuum ist kalt.", "Mars ist unser Ziel.", "Der n√§chste Schritt beginnt.", "Sei bereit f√ºr den Sprung."];
        const SENTENCES_REQUIRED = 3;
        const TOTAL_WORDS_COUNT = 10;
        
        let capturedWords = [];
        let currentWordIndex = 0;
        let spans = [];

        function unlockAudio() {
            if ('speechSynthesis' in window) {
                const emptyUtterance = new SpeechSynthesisUtterance("");
                window.speechSynthesis.speak(emptyUtterance);
            }
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'de-DE';
                window.speechSynthesis.speak(utterance);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateCombinedWords(totalCount, sentenceCount) {
            let result = [];
            let sentencePool = [...WORD_POOL_SENTENCES];
            let numSentences = Math.min(sentenceCount, sentencePool.length);
            for (let i = 0; i < numSentences; i++) {
                const randomIndex = Math.floor(Math.random() * sentencePool.length);
                result.push(sentencePool[randomIndex]);
                sentencePool.splice(randomIndex, 1);
            }
            let wordPool = [...WORD_POOL_WORDS];
            let numWords = totalCount - result.length;
            for (let i = 0; i < numWords; i++) {
                if (wordPool.length === 0) break;
                const randomIndex = Math.floor(Math.random() * wordPool.length);
                result.push(wordPool[randomIndex]);
                wordPool.splice(randomIndex, 1);
            }
            return shuffleArray(result);
        }

        function calculateFontSize(text) {
            const length = text.length;
            if (length <= 7) return '15vw'; 
            if (length <= 15) return '10vw';
            return '6vw'; 
        }

        function initRecognition() {
            if (!SpeechRecognition) return null;
            const rec = new SpeechRecognition();
            rec.lang = 'de-DE';
            rec.continuous = false; 
            rec.interimResults = false;
            return rec;
        }
        
        recognition = initRecognition();

        function loadWords() {
            currentWordIndex = 0;
            capturedWords = generateCombinedWords(TOTAL_WORDS_COUNT, SENTENCES_REQUIRED);
            
            if (capturedWords.length === TOTAL_WORDS_COUNT) {
                wordDisplay.innerHTML = '';
                capturedWords.forEach(word => {
                    const span = document.createElement('span');
                    span.textContent = word;
                    span.style.fontSize = calculateFontSize(word); 
                    span.style.display = 'none'; 
                    wordDisplay.appendChild(span);
                });
                spans = wordDisplay.querySelectorAll('span');

                initialMessage.textContent = ''; 
                
                startButton.disabled = false;
                readButton.disabled = true; 
                
                nextWordButton.textContent = 'N√§chstes Wort (0/10)';
                nextWordButton.removeEventListener('click', restartSequence);
                nextWordButton.addEventListener('click', showNextWord);
                nextWordButton.disabled = true; 
            } else {
                initialMessage.textContent = 'Fehler beim Laden.';
            }
        }

        function startReading() {
            if (!recognition) {
                initialMessage.textContent = '‚ùå';
                speakText("Mikrofon Fehler");
                return;
            }
            readButton.classList.add('recording');
            readButton.textContent = "‚èπ Stopp";
            readButton.disabled = false; 
            startButton.disabled = true;
            nextWordButton.disabled = true; 
            
            isRecording = true;
            initialMessage.textContent = 'üëÇ'; 
            
            recognition.onresult = checkReading;
            recognition.onerror = (event) => {
                 readButton.classList.remove('recording');
                 readButton.textContent = "üé§ Laut vorlesen";
                 isRecording = false;
                 if (event.error !== 'no-speech') initialMessage.textContent = '‚ùå';
                 if (currentWordIndex <= capturedWords.length) nextWordButton.disabled = false;
            };
            recognition.onend = () => {
                if(isRecording) { 
                    readButton.classList.remove('recording');
                    readButton.textContent = "üé§ Laut vorlesen";
                    isRecording = false;
                    if (currentWordIndex <= capturedWords.length) nextWordButton.disabled = false;
                }
            };
            recognition.start();
        }

        function stopReading() {
            if (isRecording && recognition) {
                recognition.stop();
                isRecording = false;
                readButton.classList.remove('recording');
                readButton.textContent = "üé§ Laut vorlesen";
                if (currentWordIndex <= capturedWords.length) nextWordButton.disabled = false;
            }
        }

        function checkReading(event) {
            readButton.classList.remove('recording');
            readButton.textContent = "üé§ Laut vorlesen";
            readButton.disabled = true; 
            isRecording = false;
            
            const currentSpan = spans[currentWordIndex - 1]; 
            const currentTargetWord = currentSpan.textContent.toLowerCase().trim();
            let recognizedText = '';
            let isCorrect = false;

            if (event && event.results && event.results.length > 0) {
                 recognizedText = event.results[0][0].transcript.toLowerCase().trim();
            }

            if (recognizedText.includes(currentTargetWord)) isCorrect = true;
            else if (currentTargetWord.length > 0 && recognizedText.includes(currentTargetWord.substring(0, 4))) isCorrect = true;
            else if (recognizedText.length > 0 && currentTargetWord.includes(recognizedText)) isCorrect = true;

            currentSpan.classList.remove('correct', 'incorrect');
            initialMessage.classList.remove('feedback-correct', 'feedback-incorrect');

            if (isCorrect) {
                initialMessage.textContent = "‚úÖ";
                speakText("Richtig!");
                initialMessage.classList.add('feedback-correct');
            } else {
                initialMessage.textContent = "‚ùå";
                speakText("Leider falsch.");
                initialMessage.classList.add('feedback-incorrect');
            }
            initialMessage.style.display = 'block';

            if (currentWordIndex <= capturedWords.length) nextWordButton.disabled = false; 
            readButton.disabled = false; 
        }

        function restartSequence() {
            initialMessage.textContent = '';
            loadWords(); 
            startButton.disabled = false;
            startButton.style.display = 'block'; 
            nextWordButton.disabled = true;
        }

        function showWordDisplayArea() {
            unlockAudio();
            videoElement.pause();
            
            videoIntroScreen.classList.add('hidden');
            videoIntroScreen.addEventListener('transitionend', () => {
                videoIntroScreen.style.display = 'none';
            }, { once: true });
            
            wordDisplayArea.style.display = 'flex'; 
            loadWords(); 
        }

        function startDisplaySequence() {
            unlockAudio();
            startButton.disabled = true;
            startButton.style.display = 'none'; 
            readButton.disabled = false; 
            showNextWord();
        }

        function showNextWord() {
            if (isRecording) stopReading();
            if (currentWordIndex > 0) {
                const prevSpan = spans[currentWordIndex - 1];
                prevSpan.style.display = 'none'; 
            }
            initialMessage.textContent = ''; 

            if (currentWordIndex < capturedWords.length) {
                const currentSpan = spans[currentWordIndex];
                currentSpan.style.display = 'block'; 
                currentWordIndex++; 
                readButton.disabled = false; 
                nextWordButton.disabled = false; 
                nextWordButton.textContent = `N√§chstes (${currentWordIndex}/${capturedWords.length})`;

                if (currentWordIndex === capturedWords.length) {
                    nextWordButton.textContent = 'Beenden';
                }
            } else {
                initialMessage.textContent = 'üèÅ';
                speakText("Protokoll abgeschlossen.");
                nextWordButton.textContent = 'Neustart';
                nextWordButton.removeEventListener('click', showNextWord);
                nextWordButton.addEventListener('click', restartSequence);
                nextWordButton.disabled = false; 
                readButton.disabled = true;
            }
        }

        playVideoButton.addEventListener('click', () => {
            unlockAudio();
            videoElement.play().catch(e => showWordDisplayArea());
            playVideoButton.disabled = true;
            videoElement.addEventListener('ended', showWordDisplayArea, { once: true });
        });

        skipToReadButton.addEventListener('click', showWordDisplayArea);
        startButton.addEventListener('click', startDisplaySequence);
        readButton.addEventListener('click', () => {
             unlockAudio();
             if (isRecording) stopReading();
             else startReading();
        });
    </script>
</body>
</html>
