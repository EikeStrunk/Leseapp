<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesen-Tab 3 (Borg-Protokoll)</title>
    <style>
        /* --- GRUNDDESIGN: BORG-√ÑSTHETIK (Dunkel, Gr√ºn) --- */
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: url('borg.png') no-repeat center center fixed;
            color: #C0C0C0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
            padding-top: 5vh;
            
            background-size: 120%; 
        }

        /* --- STYLES F√úR DEN VIDEO-STARTBILDSCHIRM (unver√§ndert) --- */
        #videoIntroScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            text-align: center;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        #videoIntroScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #videoElement {
            width: 80%;
            max-width: 900px;
            border: 2px solid #00FF00; 
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
            margin-bottom: 30px;
        }

        #videoIntroScreen h2 {
            color: #00FF00; 
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
            margin-bottom: 30px;
        }

        .intro-buttons-container {
            display: flex;
            gap: 30px;
        }

        .intro-button {
            padding: 18px 40px;
            font-size: 1.4rem;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            background-color: #00FF00; 
            box-shadow: 0 0 18px rgba(0, 255, 0, 0.9);
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .intro-button:hover {
            background-color: #39FF14;
            box-shadow: 0 0 25px rgba(0, 255, 0, 1);
        }

        /* --- STYLES F√úR DEN WORT-ANZEIGE-MODUS --- */

        #wordDisplayArea {
            display: none; 
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .screen-container {
            position: absolute; 
            width: 90%; 
            height: 50vh; 
            top: 15vh; 
            
            background-color: transparent; 
            border: none;
            box-shadow: none; 
            
            display: flex;
            justify-content: center; 
            align-items: center;
            flex-direction: column;

            left: 55%; 
            transform: translateX(-50%); 
        }

        #wordDisplay {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center; 
            align-items: center;    
            
            color: #00FF00; 
            font-size: 5rem; 
            font-weight: bold;
            text-shadow: 0 0 15px rgba(0, 255, 0, 0.9), 0 0 5px black;
            
            opacity: 0;
            transition: opacity 0.5s;
        }

        #wordDisplay span {
            position: absolute; 
            display: block;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            padding: 0 5vw; 
            border-bottom: 5px solid transparent; 
            padding-bottom: 5px;
        }
        .correct { border-bottom-color: limegreen !important; }
        .incorrect { border-bottom-color: red !important; }

        /* GE√ÑNDERT: Platzierung und Gr√∂√üe der Erfolgsmeldung */
        #initialMessage {
            position: absolute; 
            /* Gr√∂√üere Schrift */
            font-size: 2rem; 
            /* Positioniert 15% vom unteren Rand des screen-container (unter den W√∂rtern) */
            bottom: 15%; 
            color: #00FF00; 
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            text-align: center;
        }
        
        .feedback-correct { 
            color: limegreen !important;
            text-shadow: 0 0 10px limegreen;
        }
        .feedback-incorrect { 
            color: red !important;
            text-shadow: 0 0 10px red;
        }

        .control-buttons {
            position: fixed; 
            bottom: 30px; 
            left: 50%;
            transform: translateX(-50%); 
            display: flex;
            gap: 20px;
            z-index: 50; 
            opacity: 0; 
            transition: opacity 0.5s;
        }
        
        .control-buttons button {
            padding: 15px 30px;
            font-size: 1.2rem;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7); 
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        
        #startButton, #nextWordButton {
            background-color: #00FF00;
        }

        #startButton:hover, #nextWordButton:hover {
            background-color: #39FF14;
        }

        .control-buttons button:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            color: #ccc;
        }

        #readButton.recording {
            background-color: red;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    
    <div id="videoIntroScreen">
        <h2 style="color: #00FF00;">Vorbereitung zur Konvergenz: Zielsystem Scan</h2>
        <video id="videoElement" src="your_video.mp4" controls preload="auto"></video>
        <div class="intro-buttons-container">
            <button class="intro-button" id="playVideoButton">Video abspielen</button>
            <button class="intro-button" id="skipToReadButton">Direkt lesen</button>
        </div>
    </div>

    <div id="wordDisplayArea" style="display: none;">
        <div class="screen-container">
            <div id="wordDisplay"></div>
            <p id="initialMessage">Datenpaket wird generiert...</p>
        </div>
    </div>
    
    <div class="control-buttons" id="fixedControlButtons">
        <button id="startButton" disabled>Ich bin bereit</button>
        
        <button id="readButton" disabled>Ich lese laut vor. War das richtig?</button>
        
        <button id="nextWordButton" disabled>N√§chstes Wort (0/10)</button> 
    </div>


    <script>
        // --- Referenzen ---
        const videoIntroScreen = document.getElementById('videoIntroScreen');
        const videoElement = document.getElementById('videoElement');
        const playVideoButton = document.getElementById('playVideoButton');
        const skipToReadButton = document.getElementById('skipToReadButton');
        const wordDisplayArea = document.getElementById('wordDisplayArea');
        const wordDisplay = document.getElementById('wordDisplay');
        const initialMessage = document.getElementById('initialMessage');
        const fixedControlButtons = document.getElementById('fixedControlButtons');
        const startButton = document.getElementById('startButton');
        const nextWordButton = document.getElementById('nextWordButton');
        const readButton = document.getElementById('readButton');
        
        // --- API & GLOBALE ZUST√ÑNDE ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        // --- POOL AUFGETEILT IN W√ñRTER UND S√ÑTZE ---
        const WORD_POOL_WORDS = ["Kosmos", "Saturn", "Orbit", "Galaxie", "Nebel", "Astral", "Plasma", "Gravit", "Titan", "Komet", "Mond", "Sonne", "Venus", "Mars", "Alpha", "Stern", "Vakuum", "Raum", "Start", "Pilot", "Laser", "Hyper", "Terra", "Nova", "Licht", "Staub", "Schiff", "Ferne", "Spion", "Quasar", "Ringe", "Astro", "Blitz", "Himmel", "Aura", "Erde", "G√ºrtel", "Chaos", "Glimmer", "Tr√§ger", "Sonden", "Dunkel", "Weiten", "Faktor", "Reaktor", "Jupyter", "Signal", "Welle", "Meter"];
        const WORD_POOL_SENTENCES = ["Die Galaxie dreht sich schnell.", "Der Komet kommt n√§her.", "Warte auf das Signal.", "Das Schiff driftet ab.", "Tausend Sterne warten.", "Wir sind nicht allein.", "Der Flug ist vorbei.", "Aktiviere den Hyperraum.", "Das Vakuum ist kalt.", "Mars ist unser Ziel.", "Der n√§chste Schritt beginnt.", "Sei bereit f√ºr den Sprung."];
        const SENTENCES_REQUIRED = 3;
        const TOTAL_WORDS_COUNT = 10;
        const MAX_WORD_LENGTH = 30; 
        
        let capturedWords = [];
        let currentWordIndex = 0;
        let spans = [];

        // --- FUNKTIONEN F√úR DATEN & ZUFALL (unver√§ndert) ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateCombinedWords(totalCount, sentenceCount) {
            let result = [];
            let sentencePool = [...WORD_POOL_SENTENCES];
            let numSentences = Math.min(sentenceCount, sentencePool.length);
            for (let i = 0; i < numSentences; i++) {
                const randomIndex = Math.floor(Math.random() * sentencePool.length);
                result.push(sentencePool[randomIndex]);
                sentencePool.splice(randomIndex, 1);
            }

            let wordPool = [...WORD_POOL_WORDS];
            let numWords = totalCount - result.length;
            for (let i = 0; i < numWords; i++) {
                if (wordPool.length === 0) break;
                const randomIndex = Math.floor(Math.random() * wordPool.length);
                result.push(wordPool[randomIndex]);
                wordPool.splice(randomIndex, 1);
            }
            return shuffleArray(result);
        }

        function calculateFontSize(text) {
            const length = text.length;
            if (length <= 10) return '5rem';
            if (length >= MAX_WORD_LENGTH) return '1.5rem';
            const minSize = 1.5; const maxSize = 5.0; const sizeRange = maxSize - minSize; const lengthRange = MAX_WORD_LENGTH - 10; 
            const calculatedSize = maxSize - (sizeRange / lengthRange) * (length - 10);
            return `${calculatedSize.toFixed(2)}rem`;
        }

        // --- BROWSER API INITIALISIERUNG ---
        function initRecognition() {
            if (!SpeechRecognition) {
                return null;
            }
            const rec = new SpeechRecognition();
            rec.lang = 'de-DE';
            rec.continuous = false; 
            rec.interimResults = false;
            return rec;
        }
        
        recognition = initRecognition();

        // --- HAUPTFUNKTIONEN ---

        function loadWords() {
            currentWordIndex = 0;
            capturedWords = generateCombinedWords(TOTAL_WORDS_COUNT, SENTENCES_REQUIRED);
            
            if (capturedWords.length === TOTAL_WORDS_COUNT) {
                wordDisplay.innerHTML = '';
                capturedWords.forEach(word => {
                    const span = document.createElement('span');
                    span.textContent = word;
                    span.style.fontSize = calculateFontSize(word); 
                    wordDisplay.appendChild(span);
                });
                spans = wordDisplay.querySelectorAll('span');

                initialMessage.textContent = 'Bereit zur Anzeige der 10 Worte.';
                initialMessage.classList.remove('feedback-correct', 'feedback-incorrect');
                initialMessage.style.color = '#00FF00'; 
                
                startButton.disabled = false;
                readButton.disabled = true; 
                nextWordButton.textContent = 'N√§chstes Wort (0/10)';
                nextWordButton.removeEventListener('click', restartSequence);
                nextWordButton.addEventListener('click', showNextWord);

            } else {
                initialMessage.textContent = 'Fehler: Liste konnte nicht generiert werden.';
                startButton.disabled = true;
            }
        }
        
        // --- LOGIK F√úR SPRACHABGLEICH ---

        function startReadingHandler() {
             if (isRecording) {
                 stopReading();
             } else {
                 startReading();
             }
        }

        function startReading() {
            if (!recognition) {
                initialMessage.textContent = 'Fehler: Spracherkennung nicht verf√ºgbar.';
                initialMessage.classList.add('feedback-incorrect');
                initialMessage.style.display = 'block';
                return;
            }
            
            readButton.classList.add('recording');
            readButton.textContent = "üî¥ AUFNAHME L√ÑUFT. KLICKEN, UM ZU BEENDEN.";
            readButton.disabled = false; 
            startButton.disabled = true;
            nextWordButton.disabled = true; 
            isRecording = true;
            
            recognition.onresult = checkReading;
            recognition.onerror = (event) => {
                 readButton.classList.remove('recording');
                 readButton.textContent = "Ich lese laut vor. War das richtig?";
                 readButton.disabled = true;
                 isRecording = false;
                 
                 if (event.error !== 'no-speech') {
                     initialMessage.textContent = `‚ùå Aufnahme-Fehler: ${event.error}. Bitte erneut versuchen.`;
                     initialMessage.classList.add('feedback-incorrect');
                     initialMessage.style.display = 'block';
                 }
                 
                 if (currentWordIndex < capturedWords.length) {
                     nextWordButton.disabled = false; 
                 }
            };
            
            recognition.start();
            initialMessage.style.display = 'none';
        }

        function stopReading() {
            if (isRecording) {
                recognition.stop();
                isRecording = false;
            }
        }

        function checkReading(event) {
            readButton.classList.remove('recording');
            readButton.textContent = "Ich lese laut vor. War das richtig?";
            readButton.disabled = true;
            isRecording = false;
            
            const currentSpan = spans[currentWordIndex - 1]; 
            const currentTargetWord = currentSpan.textContent.toLowerCase().trim();
            let recognizedText = '';
            let isCorrect = false;

            if (event && event.results && event.results.length > 0) {
                 recognizedText = event.results[0][0].transcript.toLowerCase().trim();
            }

            // --- ABGLEICH LOGIK ---
            if (recognizedText.includes(currentTargetWord)) {
                isCorrect = true;
            } else if (currentTargetWord.length > 0 && recognizedText.includes(currentTargetWord.substring(0, Math.min(currentTargetWord.length, 4)))) {
                 isCorrect = true;
            } else if (recognizedText.length > 0 && currentTargetWord.includes(recognizedText)) {
                isCorrect = true;
            }


            // Visuelles Feedback
            currentSpan.classList.remove('correct', 'incorrect');
            initialMessage.classList.remove('feedback-correct', 'feedback-incorrect');

            if (isCorrect) {
                currentSpan.classList.add('correct');
                initialMessage.textContent = "‚úÖ √úbertragung erfolgreich! Sehr gut gelesen.";
                initialMessage.classList.add('feedback-correct');
            } else {
                currentSpan.classList.add('incorrect');
                initialMessage.textContent = `‚ùå Dekodierungsfehler. Erkannt: "${recognizedText}"`;
                initialMessage.classList.add('feedback-incorrect');
            }
            
            initialMessage.style.display = 'block';

            // WICHTIG: Reaktivierung des NEXT WORD Buttons nach erfolgreicher Pr√ºfung
            if (currentWordIndex <= capturedWords.length) { 
                nextWordButton.disabled = false; 
            }
        }


        // --- STEUERUNG & FLUSS ---

        function restartSequence() {
            initialMessage.style.display = 'block';
            wordDisplay.style.opacity = 0;
            
            loadWords(); 
        }

        function showWordDisplayArea() {
            videoIntroScreen.classList.add('hidden');
            videoIntroScreen.addEventListener('transitionend', () => {
                videoIntroScreen.style.display = 'none';
            }, { once: true });
            
            wordDisplayArea.style.display = 'flex'; 
            fixedControlButtons.style.opacity = 1; 
            
            loadWords(); 
        }

        function startDisplaySequence() {
            startButton.disabled = true;
            readButton.disabled = false; 
            initialMessage.style.display = 'none'; 
            wordDisplay.style.opacity = 1; 
            showNextWord();
        }

        function showNextWord() {
            stopReading();

            if (currentWordIndex > 0) {
                const prevSpan = spans[currentWordIndex - 1];
                prevSpan.style.opacity = 0;
                prevSpan.classList.remove('correct', 'incorrect');
            }
            
            initialMessage.classList.remove('feedback-correct', 'feedback-incorrect');
            initialMessage.style.display = 'none';

            if (currentWordIndex < capturedWords.length) {
                spans[currentWordIndex].style.opacity = 1; 
                currentWordIndex++; 
                
                readButton.disabled = false; 
                nextWordButton.disabled = true; 
                nextWordButton.textContent = `N√§chstes Wort (${currentWordIndex}/${capturedWords.length})`;

                if (currentWordIndex === capturedWords.length) {
                    
                    nextWordButton.textContent = 'Sequenz beendet';
                    nextWordButton.disabled = true; 
                    readButton.disabled = false;
                    
                    setTimeout(() => {
                        // Nach der finalen Pr√ºfung wird der Button auf Neustart umgestellt
                        if (nextWordButton.textContent === 'Sequenz beendet') {
                            nextWordButton.disabled = true;
                        }
                        
                    }, 100); 
                }
            } else {
                nextWordButton.disabled = true;
            }
        }

        // --- Event Listener Registrierung ---

        playVideoButton.addEventListener('click', () => {
            videoElement.play();
            playVideoButton.disabled = true;
            skipToReadButton.disabled = true;
            videoElement.addEventListener('ended', showWordDisplayArea, { once: true });
        });

        skipToReadButton.addEventListener('click', () => {
             playVideoButton.disabled = true;
             skipToReadButton.disabled = true;
             showWordDisplayArea();
        });

        startButton.addEventListener('click', startDisplaySequence);
        readButton.addEventListener('click', startReadingHandler); 
    </script>

</body>
</html>