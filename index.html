<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Lesen-Tab 3 (Mobile Optimized)</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: url('Borg.png') no-repeat center center fixed;
            background-size: cover; /* Cover ist sicherer f√ºr Mobile als feste % */
            color: #C0C0C0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
        }

        /* --- VIDEO SCREEN (Angepasst f√ºr Mobile) --- */
        #videoIntroScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            transition: opacity 0.5s ease-out;
        }

        #videoIntroScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #videoElement {
            width: 100%;
            max-width: 600px;
            border: 2px solid #00FF00; 
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
            margin-bottom: 20px;
            border-radius: 8px;
        }

        #videoIntroScreen h2 {
            color: #00FF00; 
            font-size: 1.5rem; /* Kleiner f√ºr Handy */
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
        }

        .intro-buttons-container {
            display: flex;
            flex-direction: column; /* Buttons untereinander auf Handy */
            gap: 15px;
            width: 80%;
        }

        .intro-button {
            padding: 15px;
            font-size: 1.1rem;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            background-color: #00FF00; 
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
        }

        /* --- WORT ANZEIGE BEREICH --- */
        #wordDisplayArea {
            display: none; 
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .screen-container {
            position: relative;
            width: 90%;
            /* Flexibler Platz: Nimmt den Raum zwischen oben und den Buttons */
            height: 60vh; 
            margin-top: 5vh;
            
            display: flex;
            justify-content: center; 
            align-items: center;
            flex-direction: column;
            
            /* Auf Mobile keine seitliche Verschiebung mehr, das verwirrt nur */
            left: 0; 
            transform: none;
        }

        #wordDisplay {
            width: 100%;
            display: flex;
            justify-content: center; 
            align-items: center;    
            color: #00FF00; 
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8), 0 0 5px black;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #wordDisplay span {
            display: block;
            width: 100%;
            word-wrap: break-word; /* Verhindert Abschneiden langer W√∂rter */
        }

        /* --- FEEDBACK MELDUNG --- */
        #initialMessage {
            position: absolute;
            bottom: 0; /* Klebt am unteren Rand des Containers */
            width: 100%;
            font-size: 1.2rem; /* Lesbare Gr√∂√üe auf Mobile */
            color: #00FF00; 
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .feedback-correct { color: limegreen !important; text-shadow: 0 0 10px limegreen; }
        .feedback-incorrect { color: red !important; text-shadow: 0 0 10px red; }

        /* --- BUTTONS UNTEN --- */
        .control-buttons {
            position: absolute; /* Absolute statt Fixed verhindert √úberlagerungsprobleme bei kleinen Screens */
            bottom: 30px; 
            width: 90%;
            display: flex;
            flex-direction: column; /* Untereinander stapeln auf Handy */
            gap: 15px;
            z-index: 50; 
            opacity: 0; 
            transition: opacity 0.5s;
        }
        
        .control-buttons button {
            padding: 15px;
            font-size: 1.1rem;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.7); 
            width: 100%; /* Volle Breite */
        }
        
        #startButton, #nextWordButton { background-color: #00FF00; }
        #readButton { background-color: #00FF00; }
        #readButton.recording { background-color: red; box-shadow: 0 0 15px red; color: white;}

        button:disabled {
            background-color: #444 !important;
            color: #888 !important;
            box-shadow: none !important;
        }

    </style>
</head>
<body>
    
    <div id="videoIntroScreen">
        <h2>Zielsystem Scan</h2>
        <video id="videoElement" src="your_video.MP4" controls playsinline preload="auto"></video>
        <div class="intro-buttons-container">
            <button class="intro-button" id="playVideoButton">‚ñ∂ Video abspielen</button>
            <button class="intro-button" id="skipToReadButton">‚è© Direkt lesen</button>
        </div>
    </div>

    <div id="wordDisplayArea">
        <div class="screen-container">
            <div id="wordDisplay"></div>
            <p id="initialMessage">Initialisiere...</p>
        </div>
        
        <div class="control-buttons" id="fixedControlButtons">
            <button id="startButton" disabled>Ich bin bereit</button>
            <button id="readButton" disabled>üé§ Laut vorlesen</button>
            <button id="nextWordButton" disabled>N√§chstes Wort (0/10)</button> 
        </div>
    </div>

    <script>
        // --- Referenzen ---
        const videoIntroScreen = document.getElementById('videoIntroScreen');
        const videoElement = document.getElementById('videoElement');
        const playVideoButton = document.getElementById('playVideoButton');
        const skipToReadButton = document.getElementById('skipToReadButton');
        const wordDisplayArea = document.getElementById('wordDisplayArea');
        const wordDisplay = document.getElementById('wordDisplay');
        const initialMessage = document.getElementById('initialMessage');
        const fixedControlButtons = document.getElementById('fixedControlButtons');
        const startButton = document.getElementById('startButton');
        const nextWordButton = document.getElementById('nextWordButton');
        const readButton = document.getElementById('readButton');
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        const WORD_POOL_WORDS = ["Kosmos", "Saturn", "Orbit", "Galaxie", "Nebel", "Astral", "Plasma", "Gravit", "Titan", "Komet", "Mond", "Sonne", "Venus", "Mars", "Alpha", "Stern", "Vakuum", "Raum", "Start", "Pilot", "Laser", "Hyper", "Terra", "Nova", "Licht", "Staub", "Schiff", "Ferne", "Spion", "Quasar", "Ringe", "Astro", "Blitz", "Himmel", "Aura", "Erde", "G√ºrtel", "Chaos", "Glimmer", "Tr√§ger", "Sonden", "Dunkel", "Weiten", "Faktor", "Reaktor", "Jupyter", "Signal", "Welle", "Meter"];
        const WORD_POOL_SENTENCES = ["Die Galaxie dreht sich schnell.", "Der Komet kommt n√§her.", "Warte auf das Signal.", "Das Schiff driftet ab.", "Tausend Sterne warten.", "Wir sind nicht allein.", "Der Flug ist vorbei.", "Aktiviere den Hyperraum.", "Das Vakuum ist kalt.", "Mars ist unser Ziel.", "Der n√§chste Schritt beginnt.", "Sei bereit f√ºr den Sprung."];
        const SENTENCES_REQUIRED = 3;
        const TOTAL_WORDS_COUNT = 10;
        const MAX_WORD_LENGTH = 30; 
        
        let capturedWords = [];
        let currentWordIndex = 0;
        let spans = [];

        // --- HELPER ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateCombinedWords(totalCount, sentenceCount) {
            let result = [];
            let sentencePool = [...WORD_POOL_SENTENCES];
            let numSentences = Math.min(sentenceCount, sentencePool.length);
            for (let i = 0; i < numSentences; i++) {
                const randomIndex = Math.floor(Math.random() * sentencePool.length);
                result.push(sentencePool[randomIndex]);
                sentencePool.splice(randomIndex, 1);
            }
            let wordPool = [...WORD_POOL_WORDS];
            let numWords = totalCount - result.length;
            for (let i = 0; i < numWords; i++) {
                if (wordPool.length === 0) break;
                const randomIndex = Math.floor(Math.random() * wordPool.length);
                result.push(wordPool[randomIndex]);
                wordPool.splice(randomIndex, 1);
            }
            return shuffleArray(result);
        }

        // --- Responsive Schriftgr√∂√üe ---
        function calculateFontSize(text) {
            const length = text.length;
            // Auf dem Handy brauchen wir kleinere Schriften als auf dem Desktop
            // Wir nutzen 'vw' (Viewport Width), damit es sich der Breite anpasst
            if (length <= 7) return '15vw'; // Sehr gro√ü f√ºr kurze W√∂rter
            if (length <= 15) return '10vw';
            return '6vw'; // Kleiner f√ºr S√§tze
        }

        function initRecognition() {
            if (!SpeechRecognition) return null;
            const rec = new SpeechRecognition();
            rec.lang = 'de-DE';
            rec.continuous = false; 
            rec.interimResults = false;
            return rec;
        }
        
        recognition = initRecognition();

        // --- CORE LOGIC ---
        function loadWords() {
            currentWordIndex = 0;
            capturedWords = generateCombinedWords(TOTAL_WORDS_COUNT, SENTENCES_REQUIRED);
            
            if (capturedWords.length === TOTAL_WORDS_COUNT) {
                wordDisplay.innerHTML = '';
                capturedWords.forEach(word => {
                    const span = document.createElement('span');
                    span.textContent = word;
                    span.style.fontSize = calculateFontSize(word); 
                    // Initiale Unsichtbarkeit
                    span.style.display = 'none'; 
                    wordDisplay.appendChild(span);
                });
                spans = wordDisplay.querySelectorAll('span');

                initialMessage.textContent = 'Bereit zur Anzeige der 10 Worte.';
                initialMessage.classList.remove('feedback-correct', 'feedback-incorrect');
                
                startButton.disabled = false;
                readButton.disabled = true; 
                nextWordButton.textContent = 'N√§chstes Wort (0/10)';
                nextWordButton.removeEventListener('click', restartSequence);
                nextWordButton.addEventListener('click', showNextWord);
            } else {
                initialMessage.textContent = 'Fehler: Liste konnte nicht generiert werden.';
                startButton.disabled = true;
            }
        }

        function startReading() {
            if (!recognition) {
                initialMessage.textContent = 'Fehler: Mikrofon nicht verf√ºgbar.';
                initialMessage.classList.add('feedback-incorrect');
                initialMessage.style.display = 'block';
                return;
            }
            
            readButton.classList.add('recording');
            readButton.textContent = "‚èπ Aufnahme stoppen";
            readButton.disabled = false; 
            startButton.disabled = true;
            nextWordButton.disabled = true; 
            isRecording = true;
            
            recognition.onresult = checkReading;
            recognition.onerror = (event) => {
                 readButton.classList.remove('recording');
                 readButton.textContent = "üé§ Laut vorlesen";
                 isRecording = false;
                 
                 if (event.error !== 'no-speech') {
                     initialMessage.textContent = `‚ùå Fehler: ${event.error}`;
                     initialMessage.classList.add('feedback-incorrect');
                     initialMessage.style.display = 'block';
                 }
                 // Fehler beim Aufnehmen -> trotzdem weiter erlauben
                 if (currentWordIndex <= capturedWords.length) nextWordButton.disabled = false;
            };
            recognition.onend = () => {
                if(isRecording) { // Falls es von selbst gestoppt hat
                    readButton.classList.remove('recording');
                    readButton.textContent = "üé§ Laut vorlesen";
                    isRecording = false;
                }
            };
            
            recognition.start();
            initialMessage.style.display = 'none';
        }

        function stopReading() {
            if (isRecording && recognition) {
                recognition.stop();
                isRecording = false;
                readButton.classList.remove('recording');
                readButton.textContent = "üé§ Laut vorlesen";
            }
        }

        function checkReading(event) {
            readButton.classList.remove('recording');
            readButton.textContent = "üé§ Laut vorlesen";
            readButton.disabled = true;
            isRecording = false;
            
            const currentSpan = spans[currentWordIndex - 1]; 
            const currentTargetWord = currentSpan.textContent.toLowerCase().trim();
            let recognizedText = '';
            let isCorrect = false;

            if (event && event.results && event.results.length > 0) {
                 recognizedText = event.results[0][0].transcript.toLowerCase().trim();
            }

            if (recognizedText.includes(currentTargetWord)) isCorrect = true;
            else if (currentTargetWord.length > 0 && recognizedText.includes(currentTargetWord.substring(0, 4))) isCorrect = true;
            else if (recognizedText.length > 0 && currentTargetWord.includes(recognizedText)) isCorrect = true;

            currentSpan.classList.remove('correct', 'incorrect');
            initialMessage.classList.remove('feedback-correct', 'feedback-incorrect');

            if (isCorrect) {
                currentSpan.classList.add('correct');
                initialMessage.textContent = "‚úÖ Richtig gelesen!";
                initialMessage.classList.add('feedback-correct');
            } else {
                currentSpan.classList.add('incorrect');
                initialMessage.textContent = `‚ùå Erkannt: "${recognizedText}"`;
                initialMessage.classList.add('feedback-incorrect');
            }
            initialMessage.style.display = 'block';

            if (currentWordIndex <= capturedWords.length) nextWordButton.disabled = false; 
        }

        function restartSequence() {
            initialMessage.style.display = 'block';
            wordDisplay.style.opacity = 0;
            loadWords(); 
        }

        function showWordDisplayArea() {
            videoIntroScreen.classList.add('hidden');
            videoIntroScreen.addEventListener('transitionend', () => {
                videoIntroScreen.style.display = 'none';
            }, { once: true });
            
            wordDisplayArea.style.display = 'flex'; 
            fixedControlButtons.style.opacity = 1; 
            loadWords(); 
        }

        function startDisplaySequence() {
            startButton.disabled = true;
            readButton.disabled = false; 
            initialMessage.style.display = 'none'; 
            wordDisplay.style.opacity = 1; 
            showNextWord();
        }

        function showNextWord() {
            stopReading();

            if (currentWordIndex > 0) {
                const prevSpan = spans[currentWordIndex - 1];
                prevSpan.style.display = 'none'; // Vorheriges Wort ganz weg
                prevSpan.classList.remove('correct', 'incorrect');
            }
            
            initialMessage.classList.remove('feedback-correct', 'feedback-incorrect');
            initialMessage.style.display = 'none';

            if (currentWordIndex < capturedWords.length) {
                const currentSpan = spans[currentWordIndex];
                currentSpan.style.display = 'block'; // Aktuelles Wort anzeigen
                
                currentWordIndex++; 
                readButton.disabled = false; 
                nextWordButton.disabled = true; 
                nextWordButton.textContent = `N√§chstes (${currentWordIndex}/${capturedWords.length})`;

                if (currentWordIndex === capturedWords.length) {
                    nextWordButton.textContent = 'Beenden';
                    setTimeout(() => {
                        if (nextWordButton.textContent === 'Beenden') nextWordButton.disabled = true;
                    }, 100); 
                }
            } else {
                // Sequenz Ende
                initialMessage.textContent = 'Protokoll abgeschlossen.';
                initialMessage.style.display = 'block';
                nextWordButton.textContent = 'Neu starten';
                nextWordButton.removeEventListener('click', showNextWord);
                nextWordButton.addEventListener('click', restartSequence);
                nextWordButton.disabled = false;
                readButton.disabled = true;
            }
        }

        // --- Event Listener ---
        playVideoButton.addEventListener('click', () => {
            // WICHTIG: User Interaction n√∂tig f√ºr Audio auf iOS
            videoElement.play().catch(e => {
                // Falls Autoplay fehlschl√§gt (selten bei Click), zeige Direkt-Button
                console.log("Play failed, switching to read mode");
                showWordDisplayArea();
            });
            playVideoButton.disabled = true;
            skipToReadButton.disabled = true;
            videoElement.addEventListener('ended', showWordDisplayArea, { once: true });
        });

        skipToReadButton.addEventListener('click', () => {
             playVideoButton.disabled = true;
             skipToReadButton.disabled = true;
             showWordDisplayArea();
        });

        startButton.addEventListener('click', startDisplaySequence);
        readButton.addEventListener('click', () => {
             if (isRecording) stopReading();
             else startReading();
        });

    </script>
</body>
</html>


